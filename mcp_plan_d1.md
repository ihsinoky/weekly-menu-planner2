# D‑1プランによるMCP開発計画

## 概要

この計画では、週次献立自動生成システムの「**D‑1プラン**」（Slack上の自然な対話による条件取得をDifyに任せ、献立生成とNotion更新は既存のPython／GitHub Actionsパイプラインで実行する）を用いて、最小限のコアプロダクト（MCP）を構築します。完成後は本システムを個人利用に耐えるプロダクトへ発展させることを目指します。

## 基本アーキテクチャ

```
Slack（ユーザー） ↔ Dify Slackボット（会話・条件取得）
                             ↓ JSON出力（intake.json）
                              ─────────────→ ストレージ（GitHub Gist または S3）
                                                                          ↓ 週次取得
GitHub Actions（cron） → Pythonスクリプト → Notion API → 週間献立DB
```

1. **対話インテーク**：ユーザーはSlack DMやチャンネルで献立方針を伝えます。DifyのSlack連携ボットが複数往復の会話で必要なスロット（必要日数、外泊日、避けたい食材、調理時間上限、優先レシピサイト、メモなど）を収集し、最終的にJSON形式の intake ファイルとして保存します。
2. **生成パイプライン**：GitHub Actions の週次ジョブが `rules.yaml` と `intake.json` を読み込み、OpenAI API で献立を生成して Notion DB へページを作成します。既存システムと同じです。
3. **編集**：ユーザーはNotion上で献立ページを自由に編集できます。次週は新しい intake がない場合、デフォルトルールのみで献立を作成します。

## MCP開発フェーズ

### フェーズ1：MCP構築（D‑1プラン）

| 項目 | 内容 |
|----|----|
| **目標** | Difyを用いたSlack対話で条件を収集し、それを既存の献立生成パイプラインに連携する最小限の機能を実装する。 |
| **期間の目安** | 1〜2週間 |
| **主なタスク** |
| 1. **Dify環境の準備** | Difyアカウント作成（クラウド版またはセルフホスト）。Slackアプリを作成し、ボットトークンと署名シークレットを取得。Dify Marketplace の Slack plugin または拡張ガイドに従って連携を設定する。 |
| 2. **チャットフロー設計** | ユーザーから取得すべきスロットを定義し、DifyのChatflowまたはAgentのツールとして組み込む。未入力スロットのみを質問するロジックを設計し、日本語で自然な対話になるようにプロンプトを調整する。 |
| 3. **保存機構の実装** | スロットがすべて埋まったら、DifyのHTTP Requestツールで intake.json を GitHub Gist（プライベート）または Amazon S3 に POST する。ファイル名には `week_start` とタイムスタンプを含めて冪等性を確保する。 |
| 4. **GitHub Actions 修正** | 既存の GitHub Actions ワークフローに intake.json の取得処理を追加する。取得できなければ rules.yaml のみで献立を生成する。 |
| 5. **テスト** | Slackで実際に会話し、JSONが正しく生成され、GitHub Actions が Notion に反映することを確認する。特に、AwayDays の指定により特定曜日の献立が空になることや、DaysNeeded が少ない場合にスキップ日が入ることを検証する。 |
| 6. **ドキュメント作成** | ユーザー向けに「Slackでの使い方」と「トラブルシューティング」を含むREADMEを用意する。 |

### フェーズ2：個人利用向けプロダクトへの発展

| 項目 | 内容 |
|----|----|
| **目標** | MCPの機能を強化し、長期的に自分だけが使える安定した献立サービスに仕上げる。 |
| **期間の目安** | フェーズ1完了後〜1か月程度 |
| **強化ポイント** |
| 1. **状態管理とメモリ** | ユーザー嗜好（特定食材の好みやアレルギー、家族構成など）を長期記憶として保存し、初回の質問を省略する。Difyの会話プロンプトに記憶情報を注入する。 |
| 2. **在庫管理との連携** | 冷蔵庫やパントリーの在庫をCSVやNotion DBで管理し、献立生成時に在庫を優先的に消費する機能を追加する。 |
| 3. **カレンダー統合** | Google Calendar APIを用いて外泊や来客予定を自動取得し、AwayDaysやGuestsを推定するオプションを追加する。ユーザーに確認を促しつつ、手入力を省力化する。 |
| 4. **UI/UXの改善** | Slack以外にもWebフォームやモバイルアプリから条件を入力できるシンプルなUIを構築する。独自のWebフロントエンドを作成する場合はDifyではなく自前のフォーム送信＋バックエンドで intake.json を生成する。 |
| 5. **メニュー生成の多様化** | 優先レシピサイトの順序やレパートリーをユーザーが自由に設定できるようにし、栄養バランスやカロリー制限など高度なオプションを追加する。 |
| 6. **デプロイとメンテナンス** | 自分のプライベートリポジトリとしてコード管理し、定期的なライブラリ更新やバックアップを行う。DifyのバージョンアップやSlack API変更に対応できるようにドキュメントを整備する。 |

## 技術要件とコスト

- **利用サービス**：Slack（無料プランでもDM利用可能）、GitHub (Pro)、OpenAI API (GPT-4o)、Dify（無料枠を想定）、Notion API。
- **コスト見積**：Difyの無料プランでは一定数のリクエストが可能。必要に応じてセルフホストに切り替えれば費用を抑えられる。OpenAI APIは週次の献立生成で月数百円程度。
- **セキュリティ**：SlackとDifyの認証情報、OpenAIキー、NotionのトークンはGitHub Secretsや環境変数で安全に管理する。会話ログに個人情報や健康情報を保存しないよう注意する。

## 完成の判断基準

1. Slack上で日本語の自然な会話による献立方針の入力が可能であり、ユーザーは1回のセッションで必要な情報を提供できること。
2. intake.json がストレージに保存され、GitHub Actionsがそれを読み込み Notion にページを作成できること。
3. 定期的な利用（週1回）でエラーなく動作し、Notionに重複ページが残らないこと。
4. ユーザードキュメントが整備され、非エンジニアでも利用手順を理解できること。

## 今後の展望

MCPの成功後は、AIアシスタントとしての会話体験を洗練させながら、在庫管理や健康管理など生活全般のサポートに広げていくことができます。その際もD‑1プランの基本設計（会話部分と生成部分を分離するアーキテクチャ）は保ちつつ、必要に応じてDify内に生成処理を取り込むD‑2プランへの拡張も検討できます。